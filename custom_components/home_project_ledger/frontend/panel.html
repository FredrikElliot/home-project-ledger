<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    .hpl-root {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: var(--primary-background-color, #fafafa);
        color: var(--primary-text-color, #212121);
        display: block;
        padding: 24px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
    }

    h1 {
        font-size: 32px;
        font-weight: 400;
        margin-bottom: 24px;
        color: var(--primary-text-color, #212121);
    }

    h2 {
        font-size: 24px;
        font-weight: 400;
        margin: 24px 0 16px 0;
        color: var(--primary-text-color, #212121);
    }

    .card {
        background-color: var(--card-background-color, #fff);
        border-radius: 8px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .button {
        background-color: var(--primary-color, #03a9f4);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .button:hover {
        background-color: var(--dark-primary-color, #0288d1);
    }

    .button.secondary {
        background-color: var(--secondary-background-color, #e0e0e0);
        color: var(--primary-text-color, #212121);
    }

    .button.secondary:hover {
        background-color: var(--divider-color, #bdbdbd);
    }

    .button.danger {
        background-color: #f44336;
    }

    .button.danger:hover {
        background-color: #d32f2f;
    }

    .project-list,
    .receipt-list {
        display: grid;
        gap: 16px;
    }

    .project-item,
    .receipt-item {
        background-color: var(--secondary-background-color, #f5f5f5);
        border-radius: 4px;
        padding: 16px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .project-item:hover,
    .receipt-item:hover {
        background-color: var(--divider-color, #e0e0e0);
    }

    .project-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .project-name {
        font-size: 18px;
        font-weight: 500;
    }

    .project-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .status-open {
        background-color: #4caf50;
        color: white;
    }

    .status-closed {
        background-color: #9e9e9e;
        color: white;
    }

    .project-details {
        font-size: 14px;
        color: var(--secondary-text-color, #757575);
    }

    .statistics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
    }

    .stat-card {
        background-color: var(--card-background-color, #fff);
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-label {
        font-size: 14px;
        color: var(--secondary-text-color, #757575);
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 500;
        color: var(--primary-color, #03a9f4);
    }

    .loading {
        text-align: center;
        padding: 48px;
        color: var(--secondary-text-color, #757575);
    }
</style>

<div class="hpl-root">
    <div class="container" id="app">
        <div class="loading">Loading...</div>
    </div>
</div>

<script>
    const APP_ROOT_ID = 'app';
    const state = {
        projects: [],
        receipts: [],
        areas: {},
        currentView: 'projects',
        currentProject: null,
        currency: 'SEK',
        hass: null,
        _refreshTimer: null,
    };

    function getHassConnection() {
        if (window.__HPL_HASS__) return window.__HPL_HASS__;
        return null;
    }

    async function init() {
        try {
            const hass = getHassConnection();
            if (!hass) {
                showError('Could not connect to Home Assistant. Please ensure you are accessing this panel from within Home Assistant.');
                return;
            }
            state.hass = hass;

            const totalEntity = state.hass.states?.["sensor.home_project_ledger_total_house_spend"];
            if (totalEntity?.attributes?.currency) {
                state.currency = totalEntity.attributes.currency;
            }

            await loadData();
            renderApp();

            if (!state._refreshTimer) {
                state._refreshTimer = setInterval(async () => {
                    try {
                        await loadData();
                        renderApp();
                    } catch (e) { }
                }, 5000);
            }
        } catch (error) {
            console.error('Failed to initialize app:', error);
            showError('Failed to load data. Please refresh the page.');
        }
    }

    async function loadData() {
        try {
            if (!state.hass) return;

            const states = Object.values(state.hass.states || {});
            const areaRegistry = await state.hass.callWS({ type: "config/area_registry/list" });
            state.areas = {};
            areaRegistry.forEach(area => {
                state.areas[area.area_id] = area.name;
            });

            const projectSensors = states.filter(s =>
                s.entity_id.startsWith('sensor.home_project_ledger_') &&
                s.entity_id.includes('_spend') &&
                !s.entity_id.includes('total_house')
            );

            const projectMap = new Map();
            projectSensors.forEach(sensor => {
                const attrs = sensor.attributes || {};
                if (attrs.project_id && attrs.project_name) {
                    projectMap.set(attrs.project_id, {
                        project_id: attrs.project_id,
                        name: attrs.project_name,
                        area_id: attrs.area_id || null,
                        status: attrs.status || 'open',
                        created_at: new Date().toISOString(),
                        closed_at: null
                    });
                }
            });

            state.projects = Array.from(projectMap.values());
            state.receipts = []; // next step: expose receipts via websocket endpoint
        } catch (error) {
            console.error('Error loading data:', error);
        }
    }

    function ensureAppRoot() {
        let root = document.getElementById(APP_ROOT_ID) || document.getElementById('hpl-app');
        if (root) {
            return root;
        }

        const host = document.querySelector('.hpl-root');
        if (host) {
            root = document.createElement('div');
            root.className = 'container';
            root.id = APP_ROOT_ID;
            host.appendChild(root);
            return root;
        }

        // Fallback: add root directly to body if structure is missing
        root = document.createElement('div');
        root.className = 'container';
        root.id = APP_ROOT_ID;
        document.body.appendChild(root);
        return root;
    }

    function getAppRoot() {
        return ensureAppRoot();
    }

    function renderApp() {
        const app = getAppRoot();
        if (!app) {
            console.error('App root element (#app) not found');
            return;
        }

        app.innerHTML = renderProjectsView();
    }

    function renderProjectsView() {
        const openProjects = state.projects.filter(p => p.status === 'open');
        const closedProjects = state.projects.filter(p => p.status === 'closed');
        const totalSpend = state.receipts.reduce((sum, r) => sum + r.total, 0);

        return `
      <h1>üè† Home Project Ledger</h1>

      <div class="statistics">
        <div class="stat-card">
          <div class="stat-label">Total Spend</div>
          <div class="stat-value">${formatCurrency(totalSpend)}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Open Projects</div>
          <div class="stat-value">${openProjects.length}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Receipts</div>
          <div class="stat-value">${state.receipts.length}</div>
        </div>
      </div>

      <div class="card">
        <h2>Projects</h2>
        ${openProjects.length === 0 && closedProjects.length === 0
                ? '<p>No projects yet. Create your first project to get started!</p>'
                : `
            ${openProjects.length > 0 ? `<h3>Open Projects</h3><div class="project-list">${openProjects.map(p => renderProjectItem(p)).join('')}</div>` : ''}
            ${closedProjects.length > 0 ? `<h3>Closed Projects</h3><div class="project-list">${closedProjects.map(p => renderProjectItem(p)).join('')}</div>` : ''}
          `
            }
      </div>

      <div class="card">
        <h2>Note (MVP)</h2>
        <p>Receipts will appear once exposed via a websocket/API endpoint. For now, totals come from sensors.</p>
      </div>
    `;
    }

    function renderProjectItem(project) {
        const areaName = project.area_id ? (state.areas[project.area_id] || 'Unknown Area') : 'No Area';
        return `
      <div class="project-item">
        <div class="project-header">
          <div class="project-name">${escapeHtml(project.name)}</div>
          <div class="project-status status-${project.status}">${project.status.toUpperCase()}</div>
        </div>
        <div class="project-details">Area: ${escapeHtml(areaName)}</div>
      </div>
    `;
    }

    function formatCurrency(amount) {
        return new Intl.NumberFormat('sv-SE', { style: 'currency', currency: state.currency }).format(amount);
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        const app = getAppRoot();
        if (!app) return;
        app.innerHTML = `
      <div class="card">
        <h2>Error</h2>
        <p>${escapeHtml(message)}</p>
      </div>
    `;
    }

        if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
        } else {
                init();
        }
</script>