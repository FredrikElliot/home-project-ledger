name: Setup Repository Topics

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: read
  # Required to update repository topics
  administration: write

jobs:
  setup-topics:
    runs-on: ubuntu-latest
    steps:
      - name: Set repository topics
        uses: actions/github-script@v7
        with:
          script: |
            const requiredTopics = ['home-assistant', 'hacs', 'integration'];
            
            try {
              // Get current topics
              const { data: repo } = await github.rest.repos.get({
                owner: context.repo.owner,
                repo: context.repo.repo
              });
              
              const currentTopics = repo.topics || [];
              const topicsToAdd = requiredTopics.filter(topic => !currentTopics.includes(topic));
              
              if (topicsToAdd.length > 0) {
                console.log(`Adding topics: ${topicsToAdd.join(', ')}`);
                const newTopics = [...new Set([...currentTopics, ...requiredTopics])];
                
                await github.rest.repos.replaceAllTopics({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  names: newTopics
                });
                
                console.log(`Successfully added topics: ${topicsToAdd.join(', ')}`);
                console.log(`Current topics: ${newTopics.join(', ')}`);
              } else {
                console.log('All required topics already present.');
                console.log(`Current topics: ${currentTopics.join(', ')}`);
              }
            } catch (error) {
              console.error('Error setting topics:', error.message);
              // Don't fail the workflow if we can't set topics
              // This allows the workflow to run even without admin permissions
              console.log('Please manually add the following topics to the repository:');
              console.log(requiredTopics.join(', '));
            }

